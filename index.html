<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        /* Control Panel Styles */
        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #6bcf7f 0%, #4caf50 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #ffd93d 0%, #ffb347 100%); color: white; }
        .btn-info { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: white; }
        .btn-secondary { background: #666; color: white; }
        .btn-danger { background: linear-gradient(135deg, #ff6b6b 0%, #e74c3c 100%); color: white; }

        .search-box {
            margin-top: 15px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 500px;
            margin: 50px auto;
            padding: 25px;
            border-radius: 12px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .form-actions button {
            flex: 1;
        }

        .dashboard-content {
            padding: 25px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }

        .chart-card h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
            font-size: 1.4em;
            font-weight: 600;
        }

        .students-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
        }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        .student-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #4facfe;
        }

        .student-card h4 {
            color: #4facfe;
            margin-bottom: 12px;
            font-size: 1.3em;
        }

        .progress-container {
            margin: 15px 0;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 12px;
            margin: 8px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .recent-activity {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-top: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1em;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
            font-size: 1.1em;
        }

        .last-updated {
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 0.9em;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }

        @media (max-width: 968px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            header h1 {
                font-size: 2.2em;
            }
        }

        @media (max-width: 768px) {
            .students-grid {
                grid-template-columns: 1fr;
            }
            
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 10px;
            }
            
            .button-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéì Student Performance Dashboard</h1>
            <p>Real-time analytics and student management system</p>
        </header>

        <!-- Control Panel -->
        <div class="control-panel">
            <h3>‚öôÔ∏è Management Panel</h3>
            
            <div class="button-grid">
                <button onclick="showModal('addStudentModal')" class="btn btn-primary">
                    ‚ûï Add New Student
                </button>
                
                <button onclick="showModal('addAssignmentModal')" class="btn btn-success">
                    üìù Add Assignment
                </button>
                
                <button onclick="markTodaysAttendance()" class="btn btn-warning">
                    ‚úÖ Mark Today's Attendance
                </button>
                
                <button onclick="loadDashboard()" class="btn btn-info">
                    üîÑ Refresh Data
                </button>
            </div>

            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç Search students by name or ID..." 
                       onkeyup="searchStudents()">
            </div>
        </div>

        <div class="dashboard-content">
            <div class="stats-grid" id="statsGrid">
                <div class="loading">üìä Loading statistics...</div>
            </div>

            <div class="charts-container">
                <div class="chart-card">
                    <h3>üìö Course Distribution</h3>
                    <canvas id="courseChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>üìà Performance Overview</h3>
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <div class="students-section">
                <h2 style="text-align: center; margin-bottom: 25px; color: #333;">üë• Student Performance</h2>
                <div class="students-grid" id="studentsGrid">
                    <div class="loading">üîÑ Loading student data...</div>
                </div>
            </div>

            <div class="recent-activity">
                <h3 style="text-align: center; margin-bottom: 20px; color: #333;">üìù Recent Assignments</h3>
                <table id="recentTable">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Subject</th>
                            <th>Score</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="4" style="text-align: center; padding: 30px;">Loading recent activities...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="last-updated">
            Last updated: <span id="updateTime"></span>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <h3>‚ûï Add New Student</h3>
            <form id="addStudentForm">
                <div class="form-group">
                    <label>Student ID:*</label>
                    <input type="text" name="id" required>
                </div>
                <div class="form-group">
                    <label>Name:*</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" name="email">
                </div>
                <div class="form-group">
                    <label>Phone:</label>
                    <input type="tel" name="phone">
                </div>
                <div class="form-group">
                    <label>Performance:</label>
                    <select name="performance">
                        <option value="Excellent">Excellent</option>
                        <option value="Very Good">Very Good</option>
                        <option value="Good" selected>Good</option>
                        <option value="Average">Average</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Add Student</button>
                    <button type="button" onclick="hideModal('addStudentModal')" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Assignment Modal -->
    <div id="addAssignmentModal" class="modal">
        <div class="modal-content">
            <h3>üìù Add Assignment</h3>
            <form id="addAssignmentForm">
                <div class="form-group">
                    <label>Student:*</label>
                    <select name="student_id" required id="studentSelect">
                        <option value="">Select Student</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Subject:*</label>
                    <input type="text" name="subject" required>
                </div>
                <div class="form-group">
                    <label>Score:*</label>
                    <input type="number" name="score" min="0" max="100" required>
                </div>
                <div class="form-group">
                    <label>Max Score:</label>
                    <input type="number" name="max_score" value="100">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">Add Assignment</button>
                    <button type="button" onclick="hideModal('addAssignmentModal')" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let charts = {};

        // Format numbers
        function formatNumber(num) {
            return num.toFixed(1);
        }

        // Update timestamp
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('updateTime').textContent = 
                now.toLocaleTimeString() + ' ' + now.toLocaleDateString();
        }

        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            if (modalId === 'addAssignmentModal') {
                populateStudentSelect();
            }
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Populate student dropdown
        async function populateStudentSelect() {
            try {
                const response = await fetch('/api/students');
                const students = await response.json();
                const select = document.getElementById('studentSelect');
                select.innerHTML = '<option value="">Select Student</option>';
                students.forEach(student => {
                    select.innerHTML += `<option value="${student.id}">${student.name} (${student.id})</option>`;
                });
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        // Fetch and display data
        async function loadDashboard() {
            try {
                console.log('üîÑ Loading dashboard data...');
                
                // Load overview statistics
                const overviewResponse = await fetch('/api/analytics/overview');
                if (!overviewResponse.ok) throw new Error('API not responding');
                const overviewData = await overviewResponse.json();
                
                // Load students
                const studentsResponse = await fetch('/api/students');
                if (!studentsResponse.ok) throw new Error('Students API error');
                const studentsData = await studentsResponse.json();
                
                updateStats(overviewData.overview);
                updateCourseChart(overviewData.course_distribution);
                updatePerformanceChart(studentsData);
                updateStudentsGrid(studentsData);
                updateRecentActivity(overviewData.recent_activity);
                updateTimestamp();
                
                console.log('‚úÖ Dashboard loaded successfully!');
                
            } catch (error) {
                console.error('‚ùå Error loading dashboard:', error);
                showError('Failed to load data. Please check if the server is running on port 5000.');
            }
        }

        function showError(message) {
            document.getElementById('statsGrid').innerHTML = `
                <div class="error">
                    <div style="font-size: 3em; margin-bottom: 15px;">‚ùå</div>
                    <h3>Connection Error</h3>
                    <p>${message}</p>
                    <button onclick="loadDashboard()" 
                            style="background: #4facfe; color: white; border: none; 
                                   padding: 10px 20px; border-radius: 5px; cursor: pointer; 
                                   margin-top: 15px;">
                        üîÑ Retry
                    </button>
                </div>
            `;
        }

        function updateStats(overview) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>Total Students</h3>
                    <div class="stat-number">${overview.total_students}</div>
                    <p>Registered in system</p>
                </div>
                <div class="stat-card">
                    <h3>Average CGPA</h3>
                    <div class="stat-number">${formatNumber(overview.average_cgpa)}</div>
                    <p>Overall performance</p>
                </div>
                <div class="stat-card">
                    <h3>Average Score</h3>
                    <div class="stat-number">${formatNumber(overview.average_score)}%</div>
                    <p>Assignment average</p>
                </div>
                <div class="stat-card">
                    <h3>System Status</h3>
                    <div class="stat-number">üü¢</div>
                    <p>All systems operational</p>
                </div>
            `;
        }

        function updateCourseChart(courseData) {
            const ctx = document.getElementById('courseChart').getContext('2d');
            
            if (charts.courseChart) {
                charts.courseChart.destroy();
            }
            
            charts.courseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: courseData.map(c => c.name),
                    datasets: [{
                        data: courseData.map(c => c.student_count),
                        backgroundColor: [
                            '#4facfe', '#00f2fe', '#ff6b6b', '#ffd93d',
                            '#6bcf7f', '#9b59b6', '#34495e', '#e74c3c'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
        }

        function updatePerformanceChart(studentsData) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            if (charts.performanceChart) {
                charts.performanceChart.destroy();
            }
            
            charts.performanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: studentsData.map(s => s.name),
                    datasets: [{
                        label: 'Average Score',
                        data: studentsData.map(s => s.avg_score || 0),
                        backgroundColor: '#4facfe',
                        borderColor: '#4facfe',
                        borderWidth: 1
                    }, {
                        label: 'Attendance %',
                        data: studentsData.map(s => s.attendance_percentage || 0),
                        backgroundColor: '#6bcf7f',
                        borderColor: '#6bcf7f',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Percentage'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Students'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        function updateStudentsGrid(studentsData) {
            const grid = document.getElementById('studentsGrid');
            grid.innerHTML = studentsData.map(student => `
                <div class="student-card">
                    <h4>${student.name} (${student.id})</h4>
                    <p><strong>Course:</strong> ${student.course_name}</p>
                    <p><strong>Performance:</strong> ${student.performance}</p>
                    <p><strong>Email:</strong> ${student.email || 'N/A'}</p>
                    <p><strong>Phone:</strong> ${student.phone || 'N/A'}</p>
                    
                    <div class="progress-container">
                        <strong>Average Score: ${Math.round(student.avg_score || 0)}%</strong>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${student.avg_score || 0}%"></div>
                        </div>
                    </div>
                    
                    <div class="progress-container">
                        <strong>Attendance: ${Math.round(student.attendance_percentage || 0)}%</strong>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${student.attendance_percentage || 0}%"></div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="deleteStudent('${student.id}')" class="btn btn-danger">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateRecentActivity(activities) {
            const tbody = document.querySelector('#recentTable tbody');
            if (activities && activities.length > 0) {
                tbody.innerHTML = activities.map(activity => `
                    <tr>
                        <td>${activity.student_name}</td>
                        <td>${activity.subject}</td>
                        <td><strong>${activity.score}/${activity.max_score}</strong></td>
                        <td>${new Date(activity.assignment_date).toLocaleDateString()}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px;">No recent activities found</td></tr>';
            }
        }

        // Add new student
        document.getElementById('addStudentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch('/api/student', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Student added successfully!');
                    hideModal('addStudentModal');
                    this.reset();
                    loadDashboard(); // Refresh the dashboard
                } else {
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Error adding student: ' + error.message);
            }
        });

        // Add new assignment
        document.getElementById('addAssignmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            data.score = parseInt(data.score);
            data.max_score = parseInt(data.max_score) || 100;
            
            try {
                const response = await fetch('/api/assignments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Assignment added successfully!');
                    hideModal('addAssignmentModal');
                    this.reset();
                    loadDashboard(); // Refresh the dashboard
                } else {
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Error adding assignment: ' + error.message);
            }
        });

        // Mark today's attendance for all students
        async function markTodaysAttendance() {
            if (!confirm('Mark today\'s attendance for all students?')) return;
            
            try {
                const response = await fetch('/api/students');
                const students = await response.json();
                
                for (const student of students) {
                    await fetch(`/api/student/${student.id}/attendance`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ present: true, date: new Date().toISOString().split('T')[0] })
                    });
                }
                
                alert('‚úÖ Today\'s attendance marked for all students!');
                loadDashboard(); // Refresh the dashboard
            } catch (error) {
                alert('‚ùå Error marking attendance: ' + error.message);
            }
        }

        // Search students
        async function searchStudents() {
            const query = document.getElementById('searchInput').value;
            if (query.length < 2) {
                loadDashboard(); // Reload all if query is too short
                return;
            }
            
            try {
                const response = await fetch(`/api/search/students?q=${encodeURIComponent(query)}`);
                const students = await response.json();
                updateStudentsGrid(students);
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        // Delete student
        async function deleteStudent(studentId) {
            if (confirm(`Are you sure you want to delete student ${studentId}?`)) {
                try {
                    const response = await fetch(`/api/student/${studentId}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        alert('‚úÖ Student deleted successfully!');
                        loadDashboard(); // Refresh the dashboard
                    } else {
                        alert('‚ùå Error: ' + result.error);
                    }
                } catch (error) {
                    alert('‚ùå Error deleting student: ' + error.message);
                }
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            // Refresh data every 30 seconds
            setInterval(loadDashboard, 30000);
        });
    </script>
</body>
</html>